<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Bus Tracker - Enhanced Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="description" content="Real-time bus tracking system with live location updates">
  <meta name="theme-color" content="#0ea5e9">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-blue: #0ea5e9;
      --primary-blue-dark: #0284c7;
      --secondary-blue: #3b82f6;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
      --success-green: #10b981;
      --warning-yellow: #f59e0b;
      --error-red: #ef4444;
      --dark-slate: #0f172a;
      --medium-slate: #1e293b;
      --light-slate: #334155;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-accent: #f1f5f9;
      --border-light: rgba(226, 232, 240, 0.5);
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    *::before,
    *::after {
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--dark-slate) 0%, var(--medium-slate) 50%, var(--light-slate) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      position: relative;
      overflow-x: hidden;
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 25% 15%, rgba(14, 165, 233, 0.12) 0%, transparent 45%),
        radial-gradient(circle at 75% 85%, rgba(59, 130, 246, 0.1) 0%, transparent 45%),
        radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--spacing-md);
      position: relative;
      z-index: 1;
    }

    /* Enhanced Header */
    .header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
      animation: slideInDown 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header h1 {
      font-size: clamp(2.5rem, 8vw, 4rem);
      font-weight: 900;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 20%, #cbd5e1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 4px 12px rgba(0,0,0,0.4);
      margin-bottom: var(--spacing-sm);
      position: relative;
      letter-spacing: -0.02em;
    }

    .header .subtitle {
      color: rgba(241, 245, 249, 0.9);
      font-size: clamp(1rem, 4vw, 1.25rem);
      font-weight: 500;
      letter-spacing: 0.025em;
      margin-bottom: var(--spacing-md);
    }

    .header .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-xl);
      font-size: 0.875rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Enhanced Main Card */
    .tracker-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(24px);
      border-radius: var(--radius-2xl);
      box-shadow: 
        var(--shadow-xl),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
      overflow: hidden;
      animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
      border: 1px solid var(--border-light);
      position: relative;
    }

    .tracker-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue), var(--success-green));
      z-index: 1;
    }

    /* Enhanced Map Container */
    .map-container {
      position: relative;
      height: clamp(350px, 60vh, 600px);
      border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
      overflow: hidden;
    }

    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
      touch-action: manipulation;
    }

    .map-overlay {
      position: absolute;
      top: var(--spacing-md);
      left: var(--spacing-md);
      right: var(--spacing-md);
      z-index: 1000;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
      backdrop-filter: blur(16px);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      font-size: clamp(0.875rem, 3vw, 1rem);
      font-weight: 600;
      color: #f1f5f9;
      animation: pulse 3s infinite;
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      text-align: center;
    }

    /* Enhanced Info Section */
    .info-section {
      padding: var(--spacing-xl);
      background: var(--bg-primary);
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      padding: var(--spacing-xl);
      border-radius: var(--radius-xl);
      text-align: center;
      color: white;
      box-shadow: 
        var(--shadow-lg),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      transform: translateY(0);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    @media (hover: hover) {
      .stat-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 
          0 25px 50px rgba(14, 165, 233, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.2);
      }
    }

    .stat-card.active-buses {
      background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
    }

    .stat-card.avg-distance {
      background: linear-gradient(135deg, var(--accent-orange) 0%, #d97706 100%);
    }

    .stat-card.next-arrival {
      background: linear-gradient(135deg, var(--error-red) 0%, #dc2626 100%);
    }

    .stat-label {
      font-size: clamp(0.875rem, 3vw, 1rem);
      font-weight: 600;
      opacity: 0.95;
      margin-bottom: var(--spacing-md);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: clamp(2.5rem, 8vw, 3.5rem);
      font-weight: 900;
      line-height: 1;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-unit {
      font-size: clamp(1rem, 3vw, 1.25rem);
      font-weight: 600;
      opacity: 0.9;
      margin-left: var(--spacing-xs);
    }

    /* Enhanced Bus Information */
    .bus-info-section {
      margin: var(--spacing-xl) 0;
    }

    .section-title {
      font-size: clamp(1.5rem, 5vw, 2rem);
      font-weight: 800;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-xl);
      text-align: center;
      letter-spacing: -0.025em;
    }

    /* Enhanced Table Styles */
    .table-container {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .bus-info-table {
      width: 100%;
      border-collapse: collapse;
      font-size: clamp(0.875rem, 3vw, 1rem);
    }

    .bus-info-table th {
      background: linear-gradient(135deg, var(--dark-slate) 0%, var(--medium-slate) 100%);
      color: #f8fafc;
      padding: var(--spacing-lg);
      text-align: center;
      font-weight: 700;
      font-size: clamp(0.8rem, 2.5vw, 0.95rem);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: relative;
    }

    .bus-info-table th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
    }

    .bus-info-table td {
      padding: var(--spacing-lg);
      text-align: center;
      border-bottom: 1px solid var(--border-light);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    @media (hover: hover) {
      .bus-info-table tr:hover td {
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.05) 0%, rgba(59, 130, 246, 0.03) 100%);
        transform: scale(1.01);
      }
    }

    .bus-number {
      font-weight: 800;
      font-size: clamp(1rem, 3vw, 1.25rem);
      color: var(--primary-blue);
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md);
      display: inline-block;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .bus-number-2 {
      color: var(--error-red);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
      border-color: rgba(239, 68, 68, 0.2);
    }

    .status-online {
      color: var(--success-green);
      font-weight: 600;
    }

    .status-offline {
      color: var(--text-muted);
      font-weight: 600;
    }

    .distance-cell,
    .eta-cell,
    .capacity-cell {
      font-weight: 700;
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm) var(--spacing-md);
    }

    .distance-cell {
      color: var(--success-green);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
    }

    .eta-cell {
      color: var(--error-red);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
    }

    .capacity-cell {
      color: var(--secondary-blue);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
    }

    /* Enhanced Mobile Cards */
    .mobile-cards {
      display: none;
      gap: var(--spacing-lg);
    }

    .bus-card {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .bus-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .bus-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--bg-accent);
    }

    .bus-card-number {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-blue);
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .bus-card-number.bus-2 {
      color: var(--error-red);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
      border-color: rgba(239, 68, 68, 0.2);
    }

    .bus-card-status {
      font-weight: 600;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
    }

    .bus-card-status.online {
      color: var(--success-green);
      background: rgba(16, 185, 129, 0.1);
    }

    .bus-card-status.offline {
      color: var(--text-muted);
      background: rgba(148, 163, 184, 0.1);
    }

    .bus-card-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-lg);
    }

    .bus-card-item {
      text-align: center;
      padding: var(--spacing-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
    }

    .bus-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
    }

    .bus-card-value {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .bus-card-route {
      grid-column: 1 / -1;
      text-align: center;
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-accent) 100%);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-md);
      border: 1px solid var(--border-light);
    }

    /* Enhanced Status Bar */
    .status-bar {
      background: linear-gradient(135deg, var(--dark-slate) 0%, var(--medium-slate) 100%);
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(148, 163, 184, 0.2);
      flex-wrap: wrap;
      gap: var(--spacing-md);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      flex: 1;
      min-width: 200px;
    }

    .pulse-dot {
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      flex-shrink: 0;
    }

    .pulse-dot.loading {
      background: linear-gradient(135deg, var(--warning-yellow) 0%, #d97706 100%);
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
    }

    .pulse-dot.error {
      background: linear-gradient(135deg, var(--error-red) 0%, #dc2626 100%);
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      animation: none;
    }

    .last-updated {
      font-size: clamp(0.8rem, 2.5vw, 0.9rem);
      opacity: 0.9;
      color: #cbd5e1;
      text-align: right;
    }

    /* Enhanced Loading Animation */
    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: var(--spacing-sm);
    }

    /* Keyframe Animations */
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }
      70% {
        box-shadow: 0 0 0 12px rgba(16, 185, 129, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile Responsive Breakpoints */
    @media (max-width: 1024px) {
      .container {
        padding: var(--spacing-md);
      }
      
      .info-section {
        padding: var(--spacing-lg);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: var(--spacing-sm);
      }

      .map-overlay {
        top: var(--spacing-sm);
        left: var(--spacing-sm);
        right: var(--spacing-sm);
        padding: var(--spacing-md);
      }

      .quick-stats {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }

      .status-bar {
        flex-direction: column;
        text-align: center;
        gap: var(--spacing-md);
      }

      .status-indicator {
        justify-content: center;
        min-width: auto;
      }

      .last-updated {
        text-align: center;
      }

      /* Show mobile cards, hide table */
      .table-container .bus-info-table {
        display: none;
      }

      .mobile-cards {
        display: flex;
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: var(--spacing-xs);
      }

      .tracker-card {
        border-radius: var(--radius-lg);
      }

      .map-container {
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        height: 300px;
      }

      .info-section {
        padding: var(--spacing-md);
      }

      .bus-card {
        padding: var(--spacing-lg);
      }

      .bus-card-info {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }
    }

    /* Touch and Accessibility Improvements */
    @media (hover: none) {
      .stat-card:active {
        transform: scale(0.98);
      }
      
      .bus-card:active {
        transform: scale(0.98);
      }
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* High Contrast Mode */
    @media (prefers-contrast: high) {
      .stat-card,
      .bus-card,
      .table-container {
        border: 2px solid #000;
      }
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #1e293b;
        --bg-secondary: #0f172a;
        --bg-accent: #334155;
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --border-light: rgba(148, 163, 184, 0.3);
      }
    }

    /* Custom Leaflet Styles */
    .leaflet-popup-content-wrapper {
      border-radius: var(--radius-md) !important;
      box-shadow: var(--shadow-lg) !important;
    }

    .leaflet-popup-tip {
      background: white !important;
      box-shadow: var(--shadow-md) !important;
    }

    /* Enhanced Bus Markers */
    .bus-marker {
      background: linear-gradient(135deg, var(--accent-orange) 0%, #d97706 100%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 
        0 8px 16px rgba(245, 158, 11, 0.4),
        0 0 0 4px rgba(245, 158, 11, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .bus-marker-2 {
      background: linear-gradient(135deg, var(--error-red) 0%, #dc2626 100%);
      box-shadow: 
        0 8px 16px rgba(239, 68, 68, 0.4),
        0 0 0 4px rgba(239, 68, 68, 0.1);
    }

    .bus-marker-active {
      animation: bounce 2s infinite;
    }

    .stop-marker {
      background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 
        0 8px 16px rgba(16, 185, 129, 0.4),
        0 0 0 4px rgba(16, 185, 129, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-8px);
      }
      60% {
        transform: translateY(-4px);
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Live Bus Tracker</h1>
    <p class="subtitle">Real-time bus location tracking system</p>
    <div class="status-badge">
      <div class="pulse-dot" id="header-status"></div>
      <span id="header-status-text">Initializing...</span>
    </div>
  </div>

  <div class="tracker-card">
    <div class="map-container">
      <div class="map-overlay">
        <div class="loading" id="loading" style="display: none;"></div>
        <span id="status-text">Connecting to tracking system...</span>
      </div>
      <div id="map"></div>
    </div>
    
    <div class="info-section">
      <!-- Quick Stats -->
      <div class="quick-stats">
        <div class="stat-card active-buses">
          <div class="stat-label">Active Buses</div>
          <div class="stat-value" id="active-count">0</div>
        </div>
        <div class="stat-card avg-distance">
          <div class="stat-label">Avg Distance</div>
          <div class="stat-value">
            <span id="avg-distance">--</span>
            <span class="stat-unit">km</span>
          </div>
        </div>
        <div class="stat-card next-arrival">
          <div class="stat-label">Next Arrival</div>
          <div class="stat-value">
            <span id="next-eta">--</span>
            <span class="stat-unit">min</span>
          </div>
        </div>
      </div>

      <!-- Bus Information Section -->
      <div class="bus-info-section">
        <h3 class="section-title">Live Bus Information</h3>
        
        <!-- Desktop Table View -->
        <div class="table-container">
          <table class="bus-info-table">
            <thead>
              <tr>
                <th>Bus Route</th>
                <th>Status</th>
                <th>Distance</th>
                <th>ETA</th>
                <th>Occupancy</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="bus-number">Route A</span></td>
                <td><span id="bus1-status" class="status-offline">Offline</span></td>
                <td class="distance-cell"><span id="distance1">--</span> km</td>
                <td class="eta-cell"><span id="table-eta-1">--</span> min</td>
                <td class="capacity-cell"><span id="seats1">--</span>%</td>
              </tr>
              <tr>
                <td><span class="bus-number bus-number-2">Route B</span></td>
                <td><span id="bus2-status" class="status-offline">Offline</span></td>
                <td class="distance-cell"><span id="distance2">--</span> km</td>
                <td class="eta-cell"><span id="table-eta-2">--</span> min</td>
                <td class="capacity-cell"><span id="seats2">--</span>%</td>
              </tr>
            </tbody>
          </table>
          
          <!-- Mobile Card View -->
          <div class="mobile-cards">
            <div class="bus-card">
              <div class="bus-card-header">
                <div class="bus-card-number">Route A</div>
                <div class="bus-card-status offline" id="mobile-status-1">Offline</div>
              </div>
              <div class="bus-card-info">
                <div class="bus-card-item">
                  <div class="bus-card-label">Distance</div>
                  <div class="bus-card-value"><span id="mobile-distance-1">--</span> km</div>
                </div>
                <div class="bus-card-item">
                  <div class="bus-card-label">ETA</div>
                  <div class="bus-card-value"><span id="mobile-eta-1">--</span> min</div>
                </div>
                <div class="bus-card-item">
                  <div class="bus-card-label">Occupancy</div>
                  <div class="bus-card-value"><span id="mobile-seats-1">--</span>%</div>
                </div>
                <div class="bus-card-item">
                  <div class="bus-card-label">Speed</div>
                  <div class="bus-card-value"><span id="mobile-speed-1">--</span> km/h</div>
                </div>
                <div class="bus-card-route">
                  <div class="bus-card-label">Last Update</div>
                  <div class="bus-card-value" id="mobile-update-1">--</div>
                </div>
              </div>
            </div>

            <div class="bus-card">
              <div class="bus-card-header">
                <div class="bus-card-number bus-2">Route B</div>
                <div class="bus-card-status offline" id="mobile-status-2">Offline</div>
              </div>
              <div class="bus-card-info">
                <div class="bus-card-item">
                  <div class="bus-card-label">Distance</div>
                  <div class="bus-card-value"><span id="mobile-distance-2">--</span> km</div>
                </div>
                <div class="bus-card-item">
                  <div class="bus-card-label">ETA</div>
                  <div class="bus-card-value"><span id="mobile-eta-2">--</span> min</div>
                </div>
                <div class="bus-card-item">
                  <div class="bus-card-label">Occupancy</div>
                  <div class="bus-card-value"><span id="mobile-seats-2">--</span>%</div>
                </div>
                <div class="bus-card-item">
                  <div class="bus-card-label">Speed</div>
                  <div class="bus-card-value"><span id="mobile-speed-2">--</span> km/h</div>
                </div>
                <div class="bus-card-route">
                  <div class="bus-card-label">Last Update</div>
                  <div class="bus-card-value" id="mobile-update-2">--</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="status-bar">
        <div class="status-indicator">
          <div class="pulse-dot" id="connection-status"></div>
          <span id="status-message">System initializing...</span>
        </div>
        <div class="last-updated">
          Last updated: <span id="lastUpdate">--</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Enhanced Configuration
  const CONFIG = {
    busStop: { lat: 10.829043, lng: 78.688642 },
    updateInterval: 8000, // 8 seconds for more frequent updates
    averageSpeed: 45, // km/h
    maxSeats: 50,
    channels: {
      bus1: {
        position: { id: 3014758, key: "DIG2NXTYIJA4OLFW" },
        occupancy: { id: 3015655, key: "7NOQT3SUFA3YZ2RZ" }
      },
      bus2: {
        position: { id: 3015435, key: "O0RWN5VVNG51JE8J" },
        occupancy: { id: 3015680, key: "92Q1MSPZ6B28JHDC" }
      }
    },
    map: {
      defaultZoom: 14,
      maxZoom: 18,
      minZoom: 10
    }
  };

  // Enhanced State Management
  let appState = {
    buses: {
      bus1: { 
        name: 'Route A',
        status: 'inactive',
        lastPosition: null,
        previousPosition: null,
        distance: 0,
        eta: 0,
        occupancy: 0,
        speed: 0,
        lastUpdate: null
      },
      bus2: { 
        name: 'Route B',
        status: 'inactive',
        lastPosition: null,
        previousPosition: null,
        distance: 0,
        eta: 0,
        occupancy: 0,
        speed: 0,
        lastUpdate: null
      }
    },
    systemStatus: {
      isOnline: false,
      activeBuses: 0,
      avgDistance: 0,
      nextEta: null,
      lastUpdate: null
    },
    ui: {
      isInitialized: false,
      updateInProgress: false
    }
  };

  // Initialize Enhanced Map
  const map = L.map('map', {
    zoomControl: true,
    scrollWheelZoom: true,
    doubleClickZoom: true,
    touchZoom: true,
    dragging: true,
    tap: true,
    keyboard: true
  }).setView([CONFIG.busStop.lat, CONFIG.busStop.lng], CONFIG.map.defaultZoom);

  // Add enhanced tile layer with error handling
  const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors',
    maxZoom: CONFIG.map.maxZoom,
    minZoom: CONFIG.map.minZoom,
    crossOrigin: true
  });

  tileLayer.on('tileerror', function(e) {
    console.warn('Tile loading error:', e);
  });

  tileLayer.addTo(map);

  // Enhanced Bus Stop Marker
  const busStopIcon = L.divIcon({
    html: `<div class="stop-marker">üöè</div>`,
    iconSize: [32, 32],
    className: 'custom-div-icon'
  });

  const busStopMarker = L.marker([CONFIG.busStop.lat, CONFIG.busStop.lng], { icon: busStopIcon })
    .addTo(map)
    .bindPopup(`
      <div style="text-align: center; padding: 8px;">
        <strong>St. Joseph's College of Engineering</strong><br>
        <span style="color: #64748b;">College Entrance</span><br>
        <small>Lat: ${CONFIG.busStop.lat}, Lng: ${CONFIG.busStop.lng}</small>
      </div>
    `)
    .openPopup();

  // Enhanced Bus Markers
  const createBusIcon = (busId, isActive = false, speed = 0) => {
    const isRoute2 = busId === 'bus2';
    let markerClass = isRoute2 ? 'bus-marker bus-marker-2' : 'bus-marker';
    
    if (isActive && speed > 0) {
      markerClass += ' bus-marker-active';
    }
    
    return L.divIcon({
      html: `<div class="${markerClass}">üöå</div>`,
      iconSize: [36, 36],
      className: 'custom-div-icon'
    });
  };

  let markers = {
    bus1: L.marker([CONFIG.busStop.lat, CONFIG.busStop.lng], { 
      icon: createBusIcon('bus1') 
    }).addTo(map),
    bus2: L.marker([CONFIG.busStop.lat, CONFIG.busStop.lng], { 
      icon: createBusIcon('bus2') 
    }).addTo(map)
  };

  // Enhanced Utility Functions
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function calculateSpeed(currentPos, previousPos, timeDiff) {
    if (!previousPos || timeDiff <= 0) return 0;
    
    const distance = getDistance(
      previousPos.lat, previousPos.lng,
      currentPos.lat, currentPos.lng
    );
    
    const hours = timeDiff / (1000 * 60 * 60); // Convert ms to hours
    return distance / hours;
  }

  function calculateETA(distance, speed) {
    if (distance === 0) return 0;
    if (speed === 0) return Math.round((distance / CONFIG.averageSpeed) * 60);
    return Math.round((distance / speed) * 60);
  }

  function formatTime(date) {
    return date.toLocaleTimeString('en-US', { 
      hour12: false, 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function formatRelativeTime(date) {
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    
    if (seconds < 60) return `${seconds}s ago`;
    if (minutes < 60) return `${minutes}m ago`;
    return formatTime(date);
  }

  // Enhanced System Status Management
  function updateSystemStatus(status, message) {
    const indicators = [
      document.getElementById('connection-status'),
      document.getElementById('header-status')
    ];
    const texts = [
      document.getElementById('status-message'),
      document.getElementById('status-text'),
      document.getElementById('header-status-text')
    ];
    
    indicators.forEach(indicator => {
      if (indicator) {
        indicator.className = `pulse-dot ${status}`;
      }
    });
    
    texts.forEach(text => {
      if (text) {
        text.textContent = message;
      }
    });
  }

  function updateBusStatus(busId, status, data = {}) {
    const busNumber = busId.slice(-1);
    const statusElements = [
      document.getElementById(`${busId}-status`),
      document.getElementById(`mobile-status-${busNumber}`)
    ];
    
    const statusText = status === 'active' ? 'Online' : 'Offline';
    const statusClass = status === 'active' ? 'status-online' : 'status-offline';
    const mobileStatusClass = status === 'active' ? 'online' : 'offline';
    
    statusElements.forEach((element, index) => {
      if (element) {
        element.textContent = statusText;
        if (index === 0) {
          element.className = statusClass;
        } else {
          element.className = `bus-card-status ${mobileStatusClass}`;
        }
      }
    });
    
    appState.buses[busId].status = status;
  }

  function updateQuickStats() {
    const buses = Object.values(appState.buses);
    const activeBuses = buses.filter(bus => bus.status === 'active');
    
    // Update active buses count
    document.getElementById('active-count').textContent = activeBuses.length;
    appState.systemStatus.activeBuses = activeBuses.length;
    
    // Update average distance
    if (activeBuses.length > 0) {
      const avgDistance = activeBuses.reduce((sum, bus) => sum + bus.distance, 0) / activeBuses.length;
      document.getElementById('avg-distance').textContent = avgDistance.toFixed(1);
      appState.systemStatus.avgDistance = avgDistance;
      
      // Update next arrival
      const nextEta = Math.min(...activeBuses.map(bus => bus.eta).filter(eta => eta > 0));
      if (nextEta !== Infinity) {
        document.getElementById('next-eta').textContent = nextEta;
        appState.systemStatus.nextEta = nextEta;
      } else {
        document.getElementById('next-eta').textContent = '--';
        appState.systemStatus.nextEta = null;
      }
    } else {
      document.getElementById('avg-distance').textContent = '--';
      document.getElementById('next-eta').textContent = '--';
      appState.systemStatus.avgDistance = 0;
      appState.systemStatus.nextEta = null;
    }
  }

  function updateUI() {
    if (appState.systemStatus.lastUpdate) {
      const updateElements = [
        document.getElementById('lastUpdate')
      ];
      
      updateElements.forEach(element => {
        if (element) {
          element.textContent = formatTime(appState.systemStatus.lastUpdate);
        }
      });
    }
    
    updateQuickStats();
  }

  // Enhanced API Functions
  async function fetchThingSpeakData(channelId, apiKey, isPosition = true) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
    
    try {
      const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?results=1&api_key=${apiKey}`;
      const response = await fetch(url, {
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
        }
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (!data.feeds || data.feeds.length === 0) {
        throw new Error('No data available');
      }
      
      const feed = data.feeds[0];
      
      if (isPosition) {
        const lat = parseFloat(feed.field1);
        const lng = parseFloat(feed.field2);
        
        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
          throw new Error('Invalid position data');
        }
        
        return { 
          lat, 
          lng, 
          timestamp: new Date(feed.created_at),
          raw: feed
        };
      } else {
        const occupancy = parseInt(feed.field1) || 0;
        return { 
          occupancy: Math.min(100, Math.max(0, occupancy)), // Clamp between 0-100
          timestamp: new Date(feed.created_at),
          raw: feed
        };
      }
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') {
        throw new Error('Request timeout');
      }
      throw error;
    }
  }

  async function updateBusData(busId, config) {
    try {
      // Fetch both position and occupancy data
      const [positionData, occupancyData] = await Promise.all([
        fetchThingSpeakData(config.position.id, config.position.key, true),
        fetchThingSpeakData(config.occupancy.id, config.occupancy.key, false)
      ]);

      const bus = appState.buses[busId];
      const currentPos = positionData;
      
      // Calculate speed if we have previous position
      let speed = 0;
      if (bus.lastPosition && bus.lastUpdate) {
        const timeDiff = positionData.timestamp - bus.lastUpdate;
        speed = calculateSpeed(currentPos, bus.lastPosition, timeDiff);
      }

      // Calculate distance to bus stop
      const distance = getDistance(
        currentPos.lat,
        currentPos.lng,
        CONFIG.busStop.lat,
        CONFIG.busStop.lng
      );

      // Calculate ETA
      const eta = calculateETA(distance, speed || CONFIG.averageSpeed);

      // Update marker position and appearance
      const isActive = speed > 0 || distance < 10; // Active if moving or nearby
      markers[busId].setLatLng([currentPos.lat, currentPos.lng]);
      markers[busId].setIcon(createBusIcon(busId, isActive, speed));
      
      // Enhanced popup with more information
      markers[busId].bindPopup(`
        <div style="text-align: center; padding: 12px; min-width: 200px;">
          <strong>üöå ${bus.name}</strong><br>
          <hr style="margin: 8px 0; border: none; border-top: 1px solid #e2e8f0;">
          <div style="display: flex; justify-content: space-between; margin: 4px 0;">
            <span>Distance:</span> <strong>${distance.toFixed(2)} km</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 4px 0;">
            <span>ETA:</span> <strong>${eta} min</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 4px 0;">
            <span>Speed:</span> <strong>${speed.toFixed(1)} km/h</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 4px 0;">
            <span>Occupancy:</span> <strong>${occupancyData.occupancy}%</strong>
          </div>
          <hr style="margin: 8px 0; border: none; border-top: 1px solid #e2e8f0;">
          <small style="color: #64748b;">Updated: ${formatRelativeTime(positionData.timestamp)}</small>
        </div>
      `);

      // Update UI elements
      const busNumber = busId.slice(-1);
      const elements = {
        distance: document.getElementById(`distance${busNumber}`),
        eta: document.getElementById(`table-eta-${busNumber}`),
        seats: document.getElementById(`seats${busNumber}`),
        mobileDistance: document.getElementById(`mobile-distance-${busNumber}`),
        mobileEta: document.getElementById(`mobile-eta-${busNumber}`),
        mobileSeats: document.getElementById(`mobile-seats-${busNumber}`),
        mobileSpeed: document.getElementById(`mobile-speed-${busNumber}`),
        mobileUpdate: document.getElementById(`mobile-update-${busNumber}`)
      };

      // Update all elements with smooth transitions
      Object.keys(elements).forEach(key => {
        const element = elements[key];
        if (element) {
          let value;
          switch(key) {
            case 'distance':
            case 'mobileDistance':
              value = distance.toFixed(2);
              break;
            case 'eta':
            case 'mobileEta':
              value = eta;
              break;
            case 'seats':
            case 'mobileSeats':
              value = occupancyData.occupancy;
              break;
            case 'mobileSpeed':
              value = speed.toFixed(1);
              break;
            case 'mobileUpdate':
              value = formatRelativeTime(positionData.timestamp);
              break;
          }
          
          if (element.textContent !== value.toString()) {
            element.style.opacity = '0.5';
            setTimeout(() => {
              element.textContent = value;
              element.style.opacity = '1';
            }, 150);
          }
        }
      });

      // Update bus status
      updateBusStatus(busId, 'active');
      
      // Store updated state
      appState.buses[busId] = {
        ...bus,
        lastPosition: currentPos,
        previousPosition: bus.lastPosition,
        distance: Number(distance.toFixed(2)),
        eta,
        occupancy: occupancyData.occupancy,
        speed: Number(speed.toFixed(1)),
        lastUpdate: positionData.timestamp
      };

      return true;
    } catch (error) {
      console.error(`Error updating ${busId}:`, error.message);

      updateBusStatus(busId, 'inactive');
      
      // Update UI with offline state
      const busNumber = busId.slice(-1);
      const offlineElements = [
        { id: `distance${busNumber}`, value: '--' },
        { id: `table-eta-${busNumber}`, value: '--' },
        { id: `seats${busNumber}`, value: '--' },
        { id: `mobile-distance-${busNumber}`, value: '--' },
        { id: `mobile-eta-${busNumber}`, value: '--' },
        { id: `mobile-seats-${busNumber}`, value: '--' },
        { id: `mobile-speed-${busNumber}`, value: '--' },
        { id: `mobile-update-${busNumber}`, value: '--' }
      ];
      
      offlineElements.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
          element.style.opacity = '0.6';
        }
      });
      
      return false;
    }
  }

  async function updateAllBuses() {
    if (appState.ui.updateInProgress) return;
    
    appState.ui.updateInProgress = true;
    updateSystemStatus('loading', 'Updating bus locations...');
    
    const loadingElement = document.getElementById('loading');
    if (loadingElement) {
      loadingElement.style.display = 'inline-block';
    }
    
    try {
      const promises = Object.entries(CONFIG.channels).map(([busId, config]) =>
        updateBusData(busId, config).catch(error => {
          console.warn(`Failed to update ${busId}:`, error.message);
          return false;
        })
      );

      const results = await Promise.all(promises);
      const successfulUpdates = results.filter(Boolean).length;
      const totalBuses = Object.keys(CONFIG.channels).length;

      // Update system status based on results
      if (successfulUpdates === totalBuses) {
        updateSystemStatus('', `All systems operational ‚Ä¢ ${successfulUpdates}/${totalBuses} buses active`);
        appState.systemStatus.isOnline = true;
      } else if (successfulUpdates > 0) {
        updateSystemStatus('loading', `Partial connectivity ‚Ä¢ ${successfulUpdates}/${totalBuses} buses active`);
        appState.systemStatus.isOnline = true;
      } else {
        updateSystemStatus('error', 'No buses responding ‚Ä¢ Check connectivity');
        appState.systemStatus.isOnline = false;
      }

      appState.systemStatus.lastUpdate = new Date();
      updateUI();

    } catch (error) {
      console.error('Critical error updating buses:', error);
      updateSystemStatus('error', 'System error ‚Ä¢ Retrying...');
      appState.systemStatus.isOnline = false;
    } finally {
      appState.ui.updateInProgress = false;
      const loadingElement = document.getElementById('loading');
      if (loadingElement) {
        loadingElement.style.display = 'none';
      }
    }
  }

  // Enhanced Initialization
  function init() {
    console.log('üöå Initializing Enhanced Bus Tracker System...');
    
    // Set initial UI state
    updateSystemStatus('loading', 'Initializing tracking system...');
    
    // Add map event listeners
    map.on('zoomend', () => {
      console.log(`Map zoom level: ${map.getZoom()}`);
    });
    
    map.on('moveend', () => {
      const center = map.getCenter();
      console.log(`Map center: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
    });
    
    // Initial data fetch
    setTimeout(() => {
      updateAllBuses();
      appState.ui.isInitialized = true;
    }, 1000);
    
    // Set up periodic updates
    setInterval(updateAllBuses, CONFIG.updateInterval);
    
    console.log('‚úÖ Bus tracker system initialized successfully');
  }

  // Enhanced Event Listeners
  document.addEventListener('DOMContentLoaded', init);

  // Handle page visibility changes for battery optimization
  let visibilityInterval;
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      // Reduce update frequency when page is hidden
      if (visibilityInterval) clearInterval(visibilityInterval);
      visibilityInterval = setInterval(updateAllBuses, CONFIG.updateInterval * 3);
      console.log('üì± Page hidden - reducing update frequency');
    } else {
      // Resume normal update frequency
      if (visibilityInterval) clearInterval(visibilityInterval);
      updateAllBuses(); // Immediate update when page becomes visible
      console.log('üì± Page visible - resuming normal updates');
    }
  });

  // Handle orientation changes
  window.addEventListener('orientationchange', function() {
    setTimeout(function() {
      map.invalidateSize();
      console.log('üì± Orientation changed - map resized');
    }, 100);
  });

  // Handle window resize
  window.addEventListener('resize', function() {
    clearTimeout(window.resizeTimer);
    window.resizeTimer = setTimeout(function() {
      map.invalidateSize();
      console.log('üíª Window resized - map adjusted');
    }, 100);
  });

  // Enhanced error handling
  window.addEventListener('unhandledrejection', function(event) {
    console.error('‚ùå Unhandled promise rejection:', event.reason);
    updateSystemStatus('error', 'System error - attempting recovery...');
    
    // Attempt recovery after 5 seconds
    setTimeout(() => {
      if (!appState.systemStatus.isOnline) {
        updateAllBuses();
      }
    }, 5000);
  });

  // Handle network connectivity
  window.addEventListener('online', function() {
    console.log('üåê Network connection restored');
    updateSystemStatus('loading', 'Connection restored - updating...');
    updateAllBuses();
  });

  window.addEventListener('offline', function() {
    console.log('üì¥ Network connection lost');
    updateSystemStatus('error', 'Network offline - will retry when connected');
  });

  // Performance monitoring
  if ('performance' in window) {
    window.addEventListener('load', function() {
      setTimeout(function() {
        const perfData = performance.getEntriesByType('navigation')[0];
        console.log(`‚ö° Page load time: ${perfData.loadEventEnd - perfData.loadEventStart}ms`);
      }, 0);
    });
  }
</script>

</body>
</html>
